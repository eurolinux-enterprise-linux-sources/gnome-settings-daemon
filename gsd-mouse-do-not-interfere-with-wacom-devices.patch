From 3c3d2dfbabe6f47307b1eb0df8ebe7c1a7780f24 Mon Sep 17 00:00:00 2001
From: Olivier Fourdan <ofourdan@redhat.com>
Date: Fri, 31 Aug 2012 09:38:48 +0200
Subject: [PATCH] mouse: do not interfere with wacom devices

https://bugzilla.redhat.com/show_bug.cgi?id=853181
---
 plugins/mouse/gsd-mouse-manager.c |   31 +++++++++++++++++++++++++++++--
 1 files changed, 29 insertions(+), 2 deletions(-)

diff --git a/plugins/mouse/gsd-mouse-manager.c b/plugins/mouse/gsd-mouse-manager.c
index ea2f5ff..d272203 100644
--- a/plugins/mouse/gsd-mouse-manager.c
+++ b/plugins/mouse/gsd-mouse-manager.c
@@ -240,6 +240,34 @@ configure_button_layout (guchar   *buttons,
 
 #ifdef HAVE_X11_EXTENSIONS_XINPUT_H
 static gboolean
+xinput_device_is_ignored (XDeviceInfo *device_info)
+{
+	static Atom stylus, eraser, pad, touch;
+
+	if ((device_info->use == IsXPointer) ||
+	    (device_info->use == IsXKeyboard))
+		return TRUE;
+
+	/* ignore devices handled by the wacom plugin */
+	if (!stylus)
+		stylus = XInternAtom (GDK_DISPLAY_XDISPLAY (gdk_display_get_default ()), "STYLUS", False);
+	if (!eraser)
+		eraser = XInternAtom (GDK_DISPLAY_XDISPLAY (gdk_display_get_default ()), "ERASER", False);
+	if (!pad)
+		pad = XInternAtom (GDK_DISPLAY_XDISPLAY (gdk_display_get_default ()), "PAD", False);
+	if (!touch)
+		touch = XInternAtom (GDK_DISPLAY_XDISPLAY (gdk_display_get_default ()), "TOUCH", False);
+
+	if ((device_info->type == stylus) ||
+	    (device_info->type == eraser) ||
+	    (device_info->type == pad) ||
+	    (device_info->type == touch))
+		return TRUE;
+
+        return FALSE;
+}
+
+static gboolean
 xinput_device_has_buttons (XDeviceInfo *device_info)
 {
         int i;
@@ -281,8 +309,7 @@ set_xinput_devices_left_handed (gboolean left_handed)
         for (i = 0; i < n_devices; i++) {
                 XDevice *device = NULL;
 
-                if ((device_info[i].use == IsXPointer) ||
-                    (device_info[i].use == IsXKeyboard) ||
+                if (xinput_device_is_ignored (&device_info[i]) ||
                     (!xinput_device_has_buttons (&device_info[i])))
                         continue;
 
-- 
1.7.1

